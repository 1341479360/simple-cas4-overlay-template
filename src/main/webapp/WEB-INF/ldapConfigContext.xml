<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:c="http://www.springframework.org/schema/c"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd">


       <bean id="authenticator" class="org.ldaptive.auth.Authenticator"
             c:resolver-ref="dnResolver"
             c:handler-ref="authHandler" />

       <bean id="dnResolver" class="org.ldaptive.auth.PooledSearchDnResolver"
             p:baseDn="${ldap.authn.baseDn}"
             p:subtreeSearch="true"
             p:allowMultipleDns="false"
             p:connectionFactory-ref="searchPooledLdapConnectionFactory"
             p:userFilter="${ldap.authn.searchFilter}" />

       <bean id="searchPooledLdapConnectionFactory"
             class="org.ldaptive.pool.PooledConnectionFactory"
             p:connectionPool-ref="searchConnectionPool" />

       <bean id="searchConnectionPool" parent="abstractConnectionPool"
             p:connectionFactory-ref="searchConnectionFactory" />

       <bean id="searchConnectionFactory"
             class="org.ldaptive.DefaultConnectionFactory"
             p:connectionConfig-ref="searchConnectionConfig" />

       <bean id="searchConnectionConfig" parent="abstractConnectionConfig"
             p:connectionInitializer-ref="bindConnectionInitializer" />

       <bean id="bindConnectionInitializer"
             class="org.ldaptive.BindConnectionInitializer"
             p:bindDn="${ldap.authn.managerDn}">
              <property name="bindCredential">
                     <bean class="org.ldaptive.Credential"
                           c:password="${ldap.authn.managerPassword}" />
              </property>
       </bean>

       <bean id="abstractConnectionPool" abstract="true"
             class="org.ldaptive.pool.BlockingConnectionPool"
             init-method="initialize"
             destroy-method="close"
             p:poolConfig-ref="ldapPoolConfig"
             p:blockWaitTime="${ldap.pool.blockWaitTime}"
             p:validator-ref="searchValidator"
             p:pruneStrategy-ref="pruneStrategy" />

       <bean id="abstractConnectionConfig" abstract="true"
             class="org.ldaptive.ConnectionConfig"
             p:ldapUrl="${ldap.url}"
             p:connectTimeout="${ldap.connectTimeout}"
             p:useStartTLS="${ldap.useStartTLS}"/>


       <bean id="ldapPoolConfig" class="org.ldaptive.pool.PoolConfig"
             p:minPoolSize="${ldap.pool.minSize}"
             p:maxPoolSize="${ldap.pool.maxSize}"
             p:validateOnCheckOut="${ldap.pool.validateOnCheckout}"
             p:validatePeriodically="${ldap.pool.validatePeriodically}"
             p:validatePeriod="${ldap.pool.validatePeriod}" />


       <bean id="pruneStrategy" class="org.ldaptive.pool.IdlePruneStrategy"
             p:prunePeriod="${ldap.pool.prunePeriod}"
             p:idleTime="${ldap.pool.idleTime}" />

       <bean id="searchValidator" class="org.ldaptive.pool.SearchValidator" />

       <bean id="authHandler" class="org.ldaptive.auth.PooledBindAuthenticationHandler"
             p:connectionFactory-ref="bindPooledLdapConnectionFactory" />

       <bean id="bindPooledLdapConnectionFactory"
             class="org.ldaptive.pool.PooledConnectionFactory"
             p:connectionPool-ref="bindConnectionPool" />

       <bean id="bindConnectionPool" parent="abstractConnectionPool"
             p:connectionFactory-ref="bindConnectionFactory" />

       <bean id="bindConnectionFactory"
             class="org.ldaptive.DefaultConnectionFactory"
             p:connectionConfig-ref="bindConnectionConfig" />

       <bean id="bindConnectionConfig" parent="abstractConnectionConfig" />

</beans>